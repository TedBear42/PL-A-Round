<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Demo</title>
  </head>
  <style>
  	.logfont{ color:#008; font-size:small;}
  	.rocket-ship{position:absolute;left:-50px;top:-50px;}
  	.gameBoard{position:absolute;left:0px;top:0px;border-style:solid;border-width:2px;background-color:#333322;height:500px;width:800px;}
  	.logdiv{position:absolute;left:0px;top:520px;border-style:solid;border-width:2px;background-color:#ffffdd;height:250px;width:400px;}
  </style>
  <body>

	<div id="gameBoard" class="gameBoard">&nbsp;</div>

	<div id="logdiv" class="logdiv"></div>





    <script src="./jquery-1.7.2.js"></script>
    <script src="./jQueryRotate.2.2.js"></script>
    <script src="socket.io/socket.io.js"></script>
    <script>

    	var maxX = 800;
    	var maxY = 500;
    	var holdTicks = false;
    	var ticksLeft = 0;



		var socket = io.connect('http://localhost:8000');


    	$(document).ready(function(){
			init();
		});


	    function init()
	    {
	    	//init key listeners
		    $(document).keydown(function(event){
				emitCommand('d', event.which);
 			});
 			$(document).keyup(function(event){
				emitCommand('u', event.which);
 			});

			//init socket listeners for events
			socket.on('events', function (dataArray)
			{

				$("#logdiv").append($('<div class="logfont">' + (new Date()) + '-EventCount:' + dataArray.events.length + '</div>'));
			    for (var i = 0; i < dataArray.events.length; i++)
			    {
			        var data = dataArray.events[i];
			    	//$("#logdiv").append($('<div class="logfont">' + (new Date()) + '-' + data.userId + ':' + data.cmdVal + '-(' + data.cmdType +')</div>'));
					shipKeyCommands(data.userId, data.cmdVal, (data.cmdType=='d'));
				}
				cleanup();

				//run too ticks before next events event
				ticksLeft += 3;
			});

			//init socket listeners for your ship ID
			socket.on('userId', function (data)
			{
				thisUserId = data.userId;

				newShip(thisUserId, data.x, data.y, data.imgIndex);

				$("#logdiv").append($('<div class="logfont">' + (new Date()) + '-UserId' + data.thisUserId + '</div>'));
			});

			//init socket listeners for other ship
			socket.on('newShip', function (data)
			{
				newShip(data.userId, data.x, data.y, data.imgIndex);

				$("#logdiv").append($('<div class="logfont">' + (new Date()) + '-newShip' + data.userId + '</div>'));

				reportShipStatus();
			});

			//init socket listeners for other ship
			socket.on('existingShip', function (ship)
			{
				newExistingShip(ship);

				$("#logdiv").append($('<div class="logfont">' + (new Date()) + '-existingShip' + ship.userId + '</div>'));
			});


			setTimeout('tick()', 50);
	    }


		//This will send commands back to the server
        var lastCmd = { cmdVal: 0, cmdType: 'x' };
	    function emitCommand(cmdType, cmdVal)
	    {

			var thisCmd = { cmdVal: cmdVal, cmdType: cmdType };
			if (lastCmd.cmdVal != thisCmd.cmdVal || lastCmd.cmdType != thisCmd.cmdType)
			{
				socket.emit('userEvent', thisCmd);
			}
			lastCmd = thisCmd;
	    }

		function tick()
		{

			if (ticksLeft > 0)
			{
				ticksLeft--;
				shipTakeKeyCommands();

				moveShip();
				slowShip();
			}
			tickCounter++;
			setTimeout('tick()', 50);
		}

		function reportShipStatus()
		{
		    var ship = ships[thisUserId];

			socket.emit('existingShip', {shipId:ship.shipId, pointingDeg:ship.pointingDeg, imgIndex:ship.imgIndex, leftPressed:ship.leftPressed, rightPressed:ship.rightPressed, xPos:ship.xPos, yPos:ship.yPos, xv:ship.xv, yv:ship.yv, upPressed:ship.upPressed});
		}


	    function cleanup()
	    {

	    	while ($("#logdiv div").size() > 10)
	    	{
	    		$("#logdiv div:first-child").remove();
	    	}

	    }


	    //ship management
	    var tickCounter = 0;
	    var ships = new Object();
	    var shipIds = [];

		function newExistingShip (ship)
		{
			if (shipIds.indexOf(ship.shipId) == -1)
	        {
				$('body').append($("<div id=\"ship" + ship.shipId + "\" class=\"rocket-ship\"><img src=\"./player_" + ship.imgIndex + ".png\"/></div>"));

				ship.height = $("#ship" + ship.shipId).height();
				ship.width = $("#ship" + ship.shipId).width();
				ship.img = $("#ship" + ship.shipId + " > img")[0];

				ship.type = "existing";
				ships[ship.shipId] = ship;
				shipIds.push(ship.shipId);
	        }
		}

		//Create new ship
	    function newShip(shipId, xPos, yPos, imgIndex)
	    {
	        if (shipIds.indexOf(shipId) == -1)
	        {
				var ship = new Object();
				ship.xPos = xPos;
				ship.yPos = yPos;
				ship.pointingDeg = 0;
				ship.xv = 0;
				ship.yv = 0;
				ship.height = 0;
				ship.width = 0;
				ship.leftPressed = false;
				ship.rightPressed = false;
				ship.upPressed = false;
				ship.shipId = shipId;
				ship.imgIndex = imgIndex;

				ship.type = "new";

				ships[shipId] = ship;
				shipIds.push(shipId);

				$('body').append($("<div id=\"ship" + shipId + "\" class=\"rocket-ship\"><img src=\"./player_" + ship.imgIndex + ".png\"/></div>"));

				ship.height = $("#ship" + shipId).height();
				ship.width = $("#ship" + shipId).width();
				ship.img = $("#ship" + shipId + " > img")[0];
			}
	    }


		function shipKeyCommands(userId, key, isPressed)
		{
			var ship = ships[userId];
			if (key == 39)
			{
				ship.leftPressed = isPressed;
			}else if (key == 37)
			{
				ship.rightPressed = isPressed;
			}else if (key == 38)
			{
				ship.upPressed = isPressed;
			}
		}

		function shipTakeKeyCommands()
		{

			for (var i = 0; i < shipIds.length; i++)
			{
				var ship = ships[shipIds[i]];
				if (ship.leftPressed)
				{
					ship.pointingDeg += 10;
				}

				if (ship.rightPressed)
				{
					ship.pointingDeg -= 10;
				}

				if (ship.upPressed)
				{
					if (tickCounter % 3 == 0)
					{
						ship.pointingDeg = ship.pointingDeg % 360;

						// convert degrees to radians
						anglexinradians = ship.pointingDeg * Math.PI / 180

						// solve for side a
						ship.xv = ship.xv + Math.sin(anglexinradians) * 3;

						// solve for side b
						ship.yv = ship.yv - Math.cos(anglexinradians) * 3;


						ship.img.src = "./player_" + ship.imgIndex + ".png";

					}
				}else
				{
					ship.img.src = "./player_" + ship.imgIndex + "-blasting.png";
				}
			}
		}

		function slowShip()
		{
			for (var i = 0; i < shipIds.length; i++)
			{
				var ship = ships[shipIds[i]];
				ship.xv = ship.xv * .95;
				ship.yv = ship.yv * .95;
			}
		}

		function moveShip()
		{
			for (var i = 0; i < shipIds.length; i++)
			{
				var ship = ships[shipIds[i]];
				ship.xPos = ship.xPos + ship.xv;
				ship.yPos = ship.yPos + ship.yv;


				if (ship.xPos < 0) { ship.xPos = 0; }
				if (ship.yPos < 0) { ship.yPos = 0; }
				if (ship.xPos > maxX - ship.width) { ship.xPos = maxX - ship.width };
				if (ship.yPos > maxY - ship.height) { ship.yPos = maxY - ship.height };

				var shipElement = $("#ship" + ship.shipId);

				shipElement.css('left', ship.xPos  + "px");
				shipElement.css('top', ship.yPos + "px");

				shipElement.rotate(ship.pointingDeg);
			}
		}

    </script>
  </body>
</html>